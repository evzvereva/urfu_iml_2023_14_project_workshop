import streamlit as st
import requests
from run import add_logo # –∏–º–ø–æ—Ä—Ç —Ñ—É–Ω–∫—Ü–∏–∏ –¥–ª—è –∑–∞–≥—Ä—É–∑–∫–∏ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è –∏ –Ω–∞–∑–≤–∞–Ω–∏—è –≤–µ–±-–∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å–∞ –≤ –º–µ–Ω—é

# –ò–º–ø–æ—Ä—Ç —Ñ—É–Ω–∫—Ü–∏–∏, –∫–æ—Ç–æ—Ä–∞—è —á–∏—Ç–∞–µ—Ç —Ñ–∞–π–ª —Å –Ω–∞—Å—Ç—Ä–æ–π–∫–∞–º–∏ –¥–ª—è –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è –∫ –º–æ–¥–µ–ª–∏ —á–µ—Ä–µ–∑ API
from api_login import api_login

# –ù–∞—Å—Ç—Ä–æ–π–∫–∞ –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è —Å—Ç—Ä–∞–Ω–∏—Ü—ã
# st.set_page_config(page_title="–ß–∞—Ç", page_icon="üóØÔ∏è")

# –í—ã–∑–æ–≤ —Ñ—É–Ω–∫—Ü–∏–∏ –¥–ª—è –∑–∞–≥—Ä—É–∑–∫–∏ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è –∏ –Ω–∞–∑–≤–∞–Ω–∏—è –≤–µ–±-–∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å–∞ –≤ –º–µ–Ω—é
add_logo()

# –ó–∞–ø–∏—Å—å —Ñ—É–Ω–∫—Ü–∏–∏ –≤ –ø–µ—Ä–µ–º–µ–Ω–Ω—É—é –¥–ª—è –¥–∞–ª—å–Ω–µ–π—à–µ–π —Ä–∞–±–æ—Ç—ã —Å –Ω–µ–π
api_log = api_login.api_login()

if api_log:
    # –ï—Å–ª–∏ —Å–æ–æ–±—â–µ–Ω–∏–π –Ω–µ—Ç –æ—Ç –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è, –ø–µ—Ä–≤–æ–µ, —á—Ç–æ –æ–Ω –≤–∏–¥–∏—Ç —ç—Ç–æ –ø—Ä–∏–≤–µ—Ç—Å–≤–∏–µ –æ—Ç –∞—Å—Å–∏—Å—Ç–µ–Ω—Ç–∞
    if "messages" not in st.session_state.keys():
        st.session_state.messages = [{"role": "assistant", "content": "–î–æ–±—Ä–æ –ø–æ–∂–∞–ª–æ–≤–∞—Ç—å! \n\n–° —Ä–∞–¥–æ—Å—Ç—å—é –ø–æ–º–æ–≥—É –æ—Ç–≤–µ—Ç–∏—Ç—å –Ω–∞ "
                                                                      "–≤–∞—à–∏ –≤–æ–ø—Ä–æ—Å—ã –æ "
                                                                      "–¥–æ—Å—Ç–æ–ø—Ä–∏–º–µ—á–∞—Ç–µ–ª—å–Ω–æ—Å—Ç—è—Ö, –º–µ—Å—Ç–∞—Ö –æ—Ç–¥—ã—Ö–∞ –∏ –ø–∏—Ç–∞–Ω–∏—è –≤ "
                                                                      "–ï–∫–∞—Ç–µ—Ä–∏–Ω–±—É—Ä–≥–µ. \n\n–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, —É—Ç–æ—á–Ω–∏—Ç–µ, —á—Ç–æ –∫–æ–Ω–∫—Ä–µ—Ç–Ω–æ "
                                                                      "–≤–∞—Å –∏–Ω—Ç–µ—Ä–µ—Å—É–µ—Ç?"}]

    # –°–æ–∑–¥–∞–Ω–∏–µ –∫–ª—é—á–µ–π —Ä–æ–ª—å –∏ –∫–æ–Ω—Ç–µ–Ω—Ç –¥–ª—è –¥–∞–ª—å–Ω–µ–π—à–µ–≥–æ –Ω–∞–ø–æ–ª–Ω–µ–Ω–∏—è
    for message in st.session_state.messages:
        with st.chat_message(message["role"]):
            st.write(message["content"])

    # –ü–æ–ª—É—á–µ–Ω–∏–µ –≤–æ–ø—Ä–æ—Å–∞ –æ—Ç –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è:
    questions_user = st.chat_input("–ù–∞–ø–∏—à–∏—Ç–µ –≤–∞—à –≤–æ–ø—Ä–æ—Å!")

    # –î–æ–±–∞–≤–ª–µ–Ω–∏–µ –≤–æ–ø—Ä–æ—Å–∞ –≤ —Å–ª–æ–≤–∞—Ä—å –¥–ª—è –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ –æ—Ç–≤–µ—Ç–∞ –Ω–∞ –Ω–µ–≥–æ –æ—Ç –∞—Å—Å–∏—Å—Ç–µ–Ω—Ç–∞
    api_log["yandexGPT"]["prompt"] = questions_user

    # –ü–µ—Ä–µ–¥–∞—á–∞ url –∏ –ø–∞—Ä–∞–º–µ—Ç—Ä–æ–≤ (API, prompt, history( history –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é —Å–ø–∏—Å–æ–∫ –ø—É—Å—Ç–æ–π)), –≤ —Ñ–æ—Ä–º–∞—Ç–µ json –ø–æ–ª—É—á–∞–µ–º —Ä–µ–∑—É–ª—å—Ç–∞—Ç
    response = requests.post(api_log["yandexGPT"]["url"], json=api_log["yandexGPT"])

    # –ü—Ä–∏ –ø–æ–ª—É—á–µ–Ω–∏–∏ –≤–æ–ø—Ä–æ—Å–∞ –æ—Ç –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è, –¥–µ–π—Å—Ç–≤—É—é—Ç —Å–ª–µ–¥—É—é—â–∏–µ —É—Å–ª–æ–≤–∏—è
    if questions_user:
        # user:
        with st.chat_message("user"):
            st.markdown(api_log["yandexGPT"]['prompt'])
        # –ø–µ—Ä–µ–¥–∞—á–∞ –≤–æ–ø—Ä–æ—Å–∞ –æ—Ç –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
        st.session_state.messages.append({"role": "user", "content": questions_user})
        # assistant:
        answer = response.json()["answer"]
        with st.chat_message("assistant"):
            st.markdown(answer)
        # –ø–µ—Ä–µ–¥–∞—á–∞ –æ—Ç–≤–µ—Ç–∞ –æ—Ç –∞—Å—Å–∏—Å—Ç–µ–Ω—Ç–∞
        st.session_state.messages.append({"role": "assistant", "content": answer})
